%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------1-D code to simulate TPV, PV devices----------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
clc
clear
close all
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%                       OPEN FILES                  %%%%%%%%%%%%%%%
fileID1 = fopen(sprintf( 'RunTime.dat') ,'w');
fileID2 = fopen(sprintf( 'Vapplied.dat') ,'a');
fileID3 = fopen(sprintf( 'V_eq.dat') ,'a');
fileID4 = fopen(sprintf( 'neq_peq.dat') ,'w');
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% SAVE RUN TIME FOR DIAGNOSTICS %%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %  profile clear;
  %  profile on;
  %% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                         %
% --------------- STEP 1: Material Properties and BCs---------------------%
%                                                                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% --- Pop-Up Windows
    f = msgbox("Welcome to 1DTPV Program","1DTPV","modal");
    set(f, 'position', [400 500 180 50]);
    uiwait(f);
    f = msgbox("We will start with including device properties");
    uiwait(f);
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
%------------------------ UNIVERSAL CONSTANTS --------------------------- %
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
[c,hj,q,kbj,kbv,e0,C1,hjc,C2] = GlobalVariables();
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
%------------------------     GENERAL INPUTS    ------------------------- %
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
[G1,sun,reflectivity,ContactSurface,MOBI,material,TMM, NA,ND,normfact, Tanode,...
 Temitter,kTanode,kbvTanode,metal,COND,Vstart,Vend,Vstep,type,Kin_e,Spl,Spr,...
 Snl,Snr,SolarIrradiance,lmin,lmax,lpoints, REC, Et,uniform]= Inputs(); 
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
% -----------------------    MATERIAL SELECTION     ----------------------%  
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
% SEMICONDUCTORS
[e,mn,mp,tn,tp,Eg,ni,Cn,Cp,RNv,RNc,Copt,Cnp] = SemiconductorMaterials(e0,Tanode,material); 
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
% -----------------------        VOLTAMMETRY        ----------------------%  
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
[Vbias,Vbieq,Vbi,Vt] = Applied_Voltage(NA,ND,ni,kTanode,q);
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
%------------------------     DEVICE PROPERTIES    -----------------------%
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
[Lps,Lns,Lpn,DL,W,Weq,xp,xn]=Device_Geometry(e,q,kTanode,ni,NA,ND,Vbias,Vbieq);
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
%---------------------------      MESH        ----------------------------%
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
[Ldp,Ldn,tstep,tend,xx,nodes,xend]= Mesh(NA,ND,kTanode,xp,xn,Lpn,e,W,uniform);
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
%                                                                         %
%---------------------------    SOLUTION    ------------------------------%
%                                                                         %
%-------------------------------------------------------------------------%
%-------------------------------------------------------------------------%
% --- Pop-Up Window
    f = msgbox("Step 1: Solution under equilibrium conditions","Solution","modal");
    set(f, 'position', [400 500 200 60]); %makes box bigger
    uiwait(f);
%-------------------------------------------------------------------------%
%-----------------------   STEP 1: EQUILIBRIUM     -----------------------%
%-------------------------------------------------------------------------%
eq = Poisson_solution_eq(DL,Lps,Lns,Vt);
% Post-processing (files + plots)
Postprocess_Equilibrium(eq);
%-------------------------------------------------------------------------%
%----------------------  STEP 2: NON-EQUILIBRIUM    ----------------------%
%-------------------------------------------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% SAVE RUN TIME FOR DIAGNOSTICS %%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%profile viewer  -history                                                   % Visualize after execution
%p = profile('info');                                                       % Save to a file
%profile off;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    END CODE    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%